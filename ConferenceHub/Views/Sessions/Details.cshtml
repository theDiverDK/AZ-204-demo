@model ConferenceHub.Models.Session

@{
    ViewData["Title"] = Model.Title;
}

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Sessions" asp-action="Index">Sessions</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
        </ol>
    </nav>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h1 class="mb-0">@Model.Title</h1>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h4 class="mb-3">Session Details</h4>
                    <p class="lead">@Model.Description</p>

                    <div class="mt-4">
                        <h5>Speaker</h5>
                        <p class="text-muted"><i class="bi bi-person-circle"></i> @Model.Speaker</p>
                    </div>

                    <div class="mt-3">
                        <h5>Schedule</h5>
                        <p><i class="bi bi-calendar-event"></i> @Model.StartTime.ToString("MMMM dd, yyyy")</p>
                        <p><i class="bi bi-clock"></i> @Model.StartTime.ToString("h:mm tt") - @Model.EndTime.ToString("h:mm tt")</p>
                    </div>

                    <div class="mt-3">
                        <h5>Location</h5>
                        <p><i class="bi bi-geo-alt"></i> @Model.Room</p>
                    </div>

                    @if (Model.SlideUrls != null && Model.SlideUrls.Any())
                    {
                        <div class="mt-3">
                            <h5>Session Slides</h5>
                            <ul class="list-group">
                                @for (var i = 0; i < Model.SlideUrls.Count; i++)
                                {
                                    var slideUrl = Model.SlideUrls[i];
                                    var extension = System.IO.Path.GetExtension(slideUrl).ToLowerInvariant();
                                    var label = extension == ".pdf" ? "PDF" : "Image";
                                    var dotIndex = slideUrl.LastIndexOf('.');
                                    var thumbnailUrl = extension == ".jpg" || extension == ".jpeg" || extension == ".png"
                                        ? (dotIndex > 0 ? slideUrl.Substring(0, dotIndex) + "-thumb.jpg" : null)
                                        : null;
                                    <li class="list-group-item">
                                        @if (!string.IsNullOrWhiteSpace(thumbnailUrl))
                                        {
                                            <a href="@slideUrl" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                                <img src="@thumbnailUrl"
                                                     alt="Slide thumbnail"
                                                     style="max-width: 180px; max-height: 120px; object-fit: cover; display: block; margin-bottom: 8px;"
                                                     loading="lazy" />
                                                <span>Slide @(i + 1) (@label)</span>
                                            </a>
                                        }
                                        else
                                        {
                                        <a href="@slideUrl" target="_blank" rel="noopener noreferrer">
                                            Slide @(i + 1) (@label)
                                        </a>
                                        }
                                    </li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="mt-3">
                        <h5>Capacity</h5>
                        <div class="progress" style="height: 25px;">
                            @{
                                var percentage = Model.Capacity > 0 ? (Model.CurrentRegistrations * 100.0 / Model.Capacity) : 0;
                                var progressClass = percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success";
                            }
                            <div class="progress-bar @progressClass" role="progressbar" style="width: @percentage%" aria-valuenow="@Model.CurrentRegistrations" aria-valuemin="0" aria-valuemax="@Model.Capacity">
                                @Model.CurrentRegistrations / @Model.Capacity
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title">Register for this Session</h5>
                            @if (Model.CurrentRegistrations < Model.Capacity)
                            {
                                @if (User.Identity?.IsAuthenticated == true)
                                {
                                    <form asp-action="Register" method="post">
                                        <input type="hidden" name="sessionId" value="@Model.Id" />
                                        <p class="text-muted mb-3">You are signed in as <strong>@User.Identity.Name</strong>.</p>
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="bi bi-check-circle"></i> Register Now
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-shield-lock"></i> Sign in to register for this session.
                                    </div>
                                    <a asp-controller="Account"
                                       asp-action="SignIn"
                                       asp-route-returnUrl="@Context.Request.Path"
                                       class="btn btn-primary w-100">
                                        <i class="bi bi-box-arrow-in-right"></i> Sign in
                                    </a>
                                }
                            }
                            else
                            {
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle"></i> This session is full
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Sessions
            </a>
        </div>
    </div>
</div>
